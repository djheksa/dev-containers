# docker-compose.yml
services:
  devcontainer:
    build:
      context: .
      dockerfile: Dockerfile
      # 빌드 시점에 .env 파일의 변수들을 Dockerfile에 전달
      args:
        - INSTALL_NODE=${INSTALL_NODE}
        - INSTALL_EXTRA_JDKS=${INSTALL_EXTRA_JDKS}
        - INSTALL_CONVENIENCE_TOOLS=${INSTALL_CONVENIENCE_TOOLS}
        - INSTALL_ZSH_PLUGINS=${INSTALL_ZSH_PLUGINS}
    
    # 컨테이너의 기본 사용자를 'dev-user'로 설정
    user: dev-user
    
    # 실행 중인 컨테이너에 .env 변수들을 전달 (post-create 스크립트용)
    environment:
      - INSTALL_NODE=${INSTALL_NODE}
      - INSTALL_EXTRA_JDKS=${INSTALL_EXTRA_JDKS}
      - INSTALL_CONVENIENCE_TOOLS=${INSTALL_CONVENIENCE_TOOLS}
      - INSTALL_ZSH_PLUGINS=${INSTALL_ZSH_PLUGINS}
    
    ports:
      - "2222:22"

    volumes:
      # 1. 소스 코드 (바인드 마운트를 통해 영속화)
      # 호스트의 projects 폴더를 컨테이너의 작업 공간으로 사용 (Git 격리)
      - ../projects:/workspace:cached
      
      # 설정 파일 접근용 (필요 시 dev_container 자체 수정 가능)
      - ../:/opt/dev_container_root:cached
      
      # 2. 도구 설정 ('dev-user'를 위한 네임드 볼륨을 통해 영속화)
      - sdkman-data:/usr/local/sdkman/candidates
      - nvm-data:/opt/nvm/versions
      - zsh-history:/home/dev-user/.zsh
      # CLI 설정(로그인 정보 등) 영속화
      - dev-user-config:/home/dev-user/.config
      - dev-user-gemini:/home/dev-user/.gemini
      # Git 설정 저장소 (파일 직접 마운트 불가 이슈 해결)
      - dev-user-gitconfig:/home/dev-user/.git-state
      # SSH 키 영속화
      - dev-user-ssh:/home/dev-user/.ssh
      
    command: sleep infinity

# 최상위 레벨에서 네임드 볼륨 선언
volumes:
  sdkman-data:
  nvm-data:
  zsh-history:
  dev-user-config:
  dev-user-gemini:
  dev-user-gitconfig:
  dev-user-ssh: